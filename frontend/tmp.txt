<template>
    <cl-dialog v-model="visible" title="åŽ†å²å¿«ç…§è®°å½•" width="960px">
      <cl-crud ref="Crud" :options="crudOptions">
        <cl-row>
          <cl-refresh-btn />
        </cl-row>
        <cl-row>
          <cl-table :columns="columns" :data="Crud.data" />
        </cl-row>
        <cl-row>
        <cl-flex1 />
        <cl-pagination
            v-model:page="Crud.pagination.value.page"
            v-model:size="Crud.pagination.value.size"
            :total="Crud.pagination.value.total"
            @change="Crud.refresh"
        />
        </cl-row>

      </cl-crud>
    </cl-dialog>
  </template>
  
  <script lang="ts" setup>
  import { ref, reactive } from "vue";
  import { useCool } from "/@/cool";
  import { ElMessage } from "element-plus";
  import { useCrud } from "@cool-vue/crud";
  
  const { service } = useCool();
  const visible = ref(false);
  
  // useCrud è‡ªåŠ¨ç®¡ç†åˆ†é¡µã€æ•°æ®åŠ è½?
  const Crud = useCrud(
    {
      service: service.star.history_excel,
    },
    (app) => {
      app.refresh(); // æ‰“å¼€å¼¹çª—æ—¶è‡ªåŠ¨åˆ·æ–?
    }
  );
  
  const crudOptions = reactive({
    service: service.star.history_excel,
  });
  
  const columns = [
    { label: "æ–‡ä»¶å?, prop: "name", minWidth: 240 },
    { label: "è¡¨å", prop: "table_name", minWidth: 160 },
    { label: "æ“ä½œäº?, prop: "operator", minWidth: 120 },
    { label: "å¿«ç…§æ—¶é—´", prop: "snapshot_time", minWidth: 180 },
    {
      label: "æ“ä½œ",
      type: "op",
      buttons: [
        {
          label: "ä¸‹è½½",
          type: "primary",
          onClick: (row: any) => download(row),
        },
      ],
    },
  ];
  
  async function download(row: any) {
    try {
      const res = await service.star.history_excel.info({ id: row.id });
  
      const blob = new Blob([res.file_data], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      });
  
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = row.name.endsWith(".xlsx") ? row.name : `${row.name}.xlsx`;
      a.click();
      window.URL.revokeObjectURL(url);
    } catch (e) {
      ElMessage.error("ä¸‹è½½å¤±è´¥");
    }
  }
  
  function open() {
    console.log("[HistoryDialog] open called");
    visible.value = true;
  }
  
  defineExpose({ open });
  </script>
  

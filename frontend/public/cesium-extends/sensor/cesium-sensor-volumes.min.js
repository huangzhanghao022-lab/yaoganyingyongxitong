!function(e,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(e="undefined"!=typeof globalThis?globalThis:e||self).CesiumSensorVolumes=i()}(this,(function(){"use strict";
/**
	 * Cesium Sensor Volumes - https://github.com/Flowm/cesium-sensor-volumes
	 *
	 * Copyright 2016 Jonathan Lounsbury
	 * Copyright 2011-2014 Analytical Graphics Inc. and Cesium Contributors
	 *
	 * Licensed under the Apache License, Version 2.0 (the "License");
	 * you may not use this file except in compliance with the License.
	 * You may obtain a copy of the License at
	 *
	 * http://www.apache.org/licenses/LICENSE-2.0
	 *
	 * Unless required by applicable law or agreed to in writing, software
	 * distributed under the License is distributed on an "AS IS" BASIS,
	 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	 * See the License for the specific language governing permissions and
	 * limitations under the License.
	 *
	 * Portions licensed separately.
	 * See https://github.com/Flowm/cesium-sensor-volumes/blob/master/LICENSE.md for full licensing details.
	 *
	 * Derived from Cesium Sensors - https://github.com/AnalyticalGraphicsInc/cesium-sensors
	 */const e=Cesium.Cartesian3,i=Cesium.Color,t=Cesium.defined,o=Cesium.Spherical,n=Cesium.TimeInterval,r=Cesium.CzmlDataSource,s=Cesium.DataSourceDisplay,a=Cesium.defaultValue,l=Cesium.DeveloperError,h=Cesium.Event,c=Cesium.createMaterialPropertyDescriptor,u=Cesium.createPropertyDescriptor,d=Cesium.AssociativeArray,m=Cesium.destroyObject,f=Cesium.Math,_=Cesium.Matrix3,p=Cesium.Matrix4,C=Cesium.Quaternion,g=Cesium.MaterialProperty,v=Cesium.Property,w=Cesium.BoundingSphere,S=Cesium.combine,y=Cesium.ComponentDatatype,A=Cesium.PrimitiveType,M=Cesium.Buffer,x=Cesium.BufferUsage,I=Cesium.DrawCommand,T=Cesium.Pass,b=Cesium.RenderState,E=Cesium.ShaderProgram,k=Cesium.ShaderSource,P=Cesium.VertexArray,H=Cesium.BlendingState,V=Cesium.CullFace,W=Cesium.Material,O=Cesium.SceneMode,F=Cesium.clone,D=function(e){this._minimumClockAngle=void 0,this._minimumClockAngleSubscription=void 0,this._maximumClockAngle=void 0,this._maximumClockAngleSubscription=void 0,this._innerHalfAngle=void 0,this._innerHalfAngleSubscription=void 0,this._outerHalfAngle=void 0,this._outerHalfAngleSubscription=void 0,this._lateralSurfaceMaterial=void 0,this._lateralSurfaceMaterialSubscription=void 0,this._intersectionColor=void 0,this._intersectionColorSubscription=void 0,this._intersectionWidth=void 0,this._intersectionWidthSubscription=void 0,this._showIntersection=void 0,this._showIntersectionSubscription=void 0,this._radius=void 0,this._radiusSubscription=void 0,this._show=void 0,this._showSubscription=void 0,this._definitionChanged=new h,this.merge(a(e,a.EMPTY_OBJECT))};Object.defineProperties(D.prototype,{definitionChanged:{get:function(){return this._definitionChanged}},minimumClockAngle:u("minimumClockAngle"),maximumClockAngle:u("maximumClockAngle"),innerHalfAngle:u("innerHalfAngle"),outerHalfAngle:u("outerHalfAngle"),lateralSurfaceMaterial:c("lateralSurfaceMaterial"),intersectionColor:u("intersectionColor"),intersectionWidth:u("intersectionWidth"),showIntersection:u("showIntersection"),radius:u("radius"),show:u("show")}),D.prototype.clone=function(e){return t(e)||(e=new D),e.show=this.show,e.innerHalfAngle=this.innerHalfAngle,e.outerHalfAngle=this.outerHalfAngle,e.minimumClockAngle=this.minimumClockAngle,e.maximumClockAngle=this.maximumClockAngle,e.radius=this.radius,e.showIntersection=this.showIntersection,e.intersectionColor=this.intersectionColor,e.intersectionWidth=this.intersectionWidth,e.lateralSurfaceMaterial=this.lateralSurfaceMaterial,e},D.prototype.merge=function(e){if(!t(e))throw new l("source is required.");this.show=a(this.show,e.show),this.innerHalfAngle=a(this.innerHalfAngle,e.innerHalfAngle),this.outerHalfAngle=a(this.outerHalfAngle,e.outerHalfAngle),this.minimumClockAngle=a(this.minimumClockAngle,e.minimumClockAngle),this.maximumClockAngle=a(this.maximumClockAngle,e.maximumClockAngle),this.radius=a(this.radius,e.radius),this.showIntersection=a(this.showIntersection,e.showIntersection),this.intersectionColor=a(this.intersectionColor,e.intersectionColor),this.intersectionWidth=a(this.intersectionWidth,e.intersectionWidth),this.lateralSurfaceMaterial=a(this.lateralSurfaceMaterial,e.lateralSurfaceMaterial)};var z="#version 300 es\n\nuniform vec4 u_intersectionColor;\nuniform float u_intersectionWidth;\n\nbool inSensorShadow(vec3 coneVertexWC, vec3 pointWC)\n{\n    \n    vec3 D = czm_ellipsoidInverseRadii;\n\n    \n    vec3 q = D * coneVertexWC;\n    float qMagnitudeSquared = dot(q, q);\n    float test = qMagnitudeSquared - 1.0;\n\n    \n    vec3 temp = D * pointWC - q;\n    float d = dot(temp, q);\n\n    \n    return (d < -test) && (d / length(temp) < -sqrt(test));\n}\n\nvec4 getIntersectionColor()\n{\n    return u_intersectionColor;\n}\n\nfloat getIntersectionWidth()\n{\n    return u_intersectionWidth;\n}\n\nvec2 sensor2dTextureCoordinates(float sensorRadius, vec3 pointMC)\n{\n    \n    float t = pointMC.z / sensorRadius;\n    float s = 1.0 + (atan(pointMC.y, pointMC.x) / czm_twoPi);\n    s = s - floor(s);\n\n    return vec2(s, t);\n}\n",R="#version 300 es\n\nuniform bool u_showIntersection;\nuniform bool u_showThroughEllipsoid;\n\nuniform float u_sensorRadius;\nuniform float u_normalDirection;\n\nin vec3 v_positionWC;\nin vec3 v_positionEC;\nin vec3 v_normalEC;\n\nvec4 getColor(float sensorRadius, vec3 pointEC)\n{\n    czm_materialInput materialInput;\n\n    vec3 pointMC = (czm_inverseModelView * vec4(pointEC, 1.0)).xyz;\n    materialInput.st = sensor2dTextureCoordinates(sensorRadius, pointMC);\n    materialInput.str = pointMC / sensorRadius;\n\n    vec3 positionToEyeEC = -v_positionEC;\n    materialInput.positionToEyeEC = positionToEyeEC;\n\n    vec3 normalEC = normalize(v_normalEC);\n    materialInput.normalEC = u_normalDirection * normalEC;\n\n    czm_material material = czm_getMaterial(materialInput);\n    return mix(czm_phong(normalize(positionToEyeEC), material, czm_lightDirectionEC), vec4(material.diffuse, material.alpha), 0.4);\n}\n\nbool isOnBoundary(float value, float epsilon)\n{\n    float width = getIntersectionWidth();\n    float tolerance = width * epsilon;\n\n    float delta = max(abs(dFdx(value)), abs(dFdy(value)));\n    float pixels = width * delta;\n    float temp = abs(value);\n    \n    \n    \n    \n    \n    \n    \n    return temp < tolerance && temp < pixels || (delta < 10.0 * tolerance && temp - delta < tolerance && temp < pixels);\n}\n\nvec4 shade(bool isOnBoundary)\n{\n    if (u_showIntersection && isOnBoundary)\n    {\n        return getIntersectionColor();\n    }\n    return getColor(u_sensorRadius, v_positionEC);\n}\n\nfloat ellipsoidSurfaceFunction(vec3 point)\n{\n    vec3 scaled = czm_ellipsoidInverseRadii * point;\n    return dot(scaled, scaled) - 1.0;\n}\n\nvoid main()\n{\n    vec3 sensorVertexWC = czm_model[3].xyz;      \n    vec3 sensorVertexEC = czm_modelView[3].xyz;  \n\n    float ellipsoidValue = ellipsoidSurfaceFunction(v_positionWC);\n\n    \n    if (!u_showThroughEllipsoid)\n    {\n        \n        \n        if (ellipsoidValue < 0.0)\n        {\n            discard;\n        }\n\n        \n        if (inSensorShadow(sensorVertexWC, v_positionWC))\n        {\n            discard;\n        }\n    }\n\n    \n    \n    if (distance(v_positionEC, sensorVertexEC) > u_sensorRadius)\n    {\n        discard;\n    }\n\n    \n    bool isOnEllipsoid = isOnBoundary(ellipsoidValue, czm_epsilon3);\n    out_FragColor = shade(isOnEllipsoid);\n}\n",N="#version 300 es\n\nin vec4 position;\nin vec3 normal;\n\nout vec3 v_positionWC;\nout vec3 v_positionEC;\nout vec3 v_normalEC;\n\nvoid main()\n{\n    gl_Position = czm_modelViewProjection * position;\n    v_positionWC = (czm_model * position).xyz;\n    v_positionEC = (czm_modelView * position).xyz;\n    v_normalEC = czm_normal * normal;\n}\n";const q={position:0,normal:1},B=5906376272e3,L=function(e){e=a(e,a.EMPTY_OBJECT),this._pickId=void 0,this._pickPrimitive=a(e._pickPrimitive,this),this._frontFaceColorCommand=new I,this._backFaceColorCommand=new I,this._pickCommand=new I,this._boundingSphere=new w,this._boundingSphereWC=new w,this._frontFaceColorCommand.primitiveType=A.TRIANGLES,this._frontFaceColorCommand.boundingVolume=this._boundingSphereWC,this._frontFaceColorCommand.owner=this,this._backFaceColorCommand.primitiveType=this._frontFaceColorCommand.primitiveType,this._backFaceColorCommand.boundingVolume=this._frontFaceColorCommand.boundingVolume,this._backFaceColorCommand.owner=this,this._pickCommand.primitiveType=this._frontFaceColorCommand.primitiveType,this._pickCommand.boundingVolume=this._frontFaceColorCommand.boundingVolume,this._pickCommand.owner=this,this.show=a(e.show,!0),this.showIntersection=a(e.showIntersection,!0),this.showThroughEllipsoid=a(e.showThroughEllipsoid,!1),this._showThroughEllipsoid=this.showThroughEllipsoid,this.modelMatrix=p.clone(a(e.modelMatrix,p.IDENTITY)),this._modelMatrix=new p,this.radius=a(e.radius,Number.POSITIVE_INFINITY),this._directions=void 0,this._directionsDirty=!1,this.directions=t(e.directions)?e.directions:[],this.lateralSurfaceMaterial=t(e.lateralSurfaceMaterial)?e.lateralSurfaceMaterial:W.fromType(W.ColorType),this._lateralSurfaceMaterial=void 0,this._translucent=void 0,this.intersectionColor=i.clone(a(e.intersectionColor,i.WHITE)),this.intersectionWidth=a(e.intersectionWidth,5),this.id=e.id,this._id=void 0;var o=this;this._uniforms={u_showThroughEllipsoid:function(){return o.showThroughEllipsoid},u_showIntersection:function(){return o.showIntersection},u_sensorRadius:function(){return isFinite(o.radius)?o.radius:B},u_intersectionColor:function(){return o.intersectionColor},u_intersectionWidth:function(){return o.intersectionWidth},u_normalDirection:function(){return 1}},this._mode=O.SCENE3D};Object.defineProperties(L.prototype,{directions:{get:function(){return this._directions},set:function(e){this._directions=e,this._directionsDirty=!0}}});const U=new e,Y=new e,j=new e;const Q=new e;function G(i,t){for(var o=function(i){for(var t=i._directions,o=t.length,n=new Float32Array(3*o),r=isFinite(i.radius)?i.radius:B,s=[e.ZERO],a=o-2,l=o-1,h=0;h<o;a=l++,l=h++){var c=e.fromSpherical(t[a],U),u=e.fromSpherical(t[l],Y),d=e.fromSpherical(t[h],j),m=Math.max(e.angleBetween(c,u),e.angleBetween(u,d)),f=r/Math.cos(.5*m),_=e.multiplyByScalar(u,f,new e);n[3*l]=_.x,n[3*l+1]=_.y,n[3*l+2]=_.z,s.push(_)}return w.fromPoints(s,i._boundingSphere),n}(i),n=i._directions.length,r=new Float32Array(18*n),s=0,a=n-1,l=0;l<n;a=l++){var h=new e(o[3*a],o[3*a+1],o[3*a+2]),c=new e(o[3*l],o[3*l+1],o[3*l+2]),u=e.normalize(e.cross(c,h,Q),Q);r[s++]=0,r[s++]=0,r[s++]=0,r[s++]=u.x,r[s++]=u.y,r[s++]=u.z,r[s++]=c.x,r[s++]=c.y,r[s++]=c.z,r[s++]=u.x,r[s++]=u.y,r[s++]=u.z,r[s++]=h.x,r[s++]=h.y,r[s++]=h.z,r[s++]=u.x,r[s++]=u.y,r[s++]=u.z}var d=M.createVertexBuffer({context:t,typedArray:new Float32Array(r),usage:x.STATIC_DRAW}),m=6*Float32Array.BYTES_PER_ELEMENT,f=[{index:q.position,vertexBuffer:d,componentsPerAttribute:3,componentDatatype:y.FLOAT,offsetInBytes:0,strideInBytes:m},{index:q.normal,vertexBuffer:d,componentsPerAttribute:3,componentDatatype:y.FLOAT,offsetInBytes:3*Float32Array.BYTES_PER_ELEMENT,strideInBytes:m}];return new P({context:t,attributes:f})}function J(e,i,o){var n=i[e.id];if(t(n)){var r=n.primitive;o.remove(r),r.isDestroyed()||r.destroy(),delete i[e.id]}}L.prototype.update=function(e){if(this._mode=e.mode,this.show&&this._mode===O.SCENE3D){var i=e.context,o=e.commandList;if(this.radius<0)throw new l("this.radius must be greater than or equal to zero.");if(!t(this.lateralSurfaceMaterial))throw new l("this.lateralSurfaceMaterial must be defined.");var n,r=this.lateralSurfaceMaterial.isTranslucent();if(this._showThroughEllipsoid!==this.showThroughEllipsoid||!t(this._frontFaceColorCommand.renderState)||this._translucent!==r)this._showThroughEllipsoid=this.showThroughEllipsoid,this._translucent=r,r?(n=b.fromCache({depthTest:{enabled:!this.showThroughEllipsoid},depthMask:!1,blending:H.ALPHA_BLEND,cull:{enabled:!0,face:V.BACK}}),this._frontFaceColorCommand.renderState=n,this._frontFaceColorCommand.pass=T.TRANSLUCENT,n=b.fromCache({depthTest:{enabled:!this.showThroughEllipsoid},depthMask:!1,blending:H.ALPHA_BLEND,cull:{enabled:!0,face:V.FRONT}}),this._backFaceColorCommand.renderState=n,this._backFaceColorCommand.pass=T.TRANSLUCENT,n=b.fromCache({depthTest:{enabled:!this.showThroughEllipsoid},depthMask:!1,blending:H.ALPHA_BLEND}),this._pickCommand.renderState=n):(n=b.fromCache({depthTest:{enabled:!0},depthMask:!0}),this._frontFaceColorCommand.renderState=n,this._frontFaceColorCommand.pass=T.OPAQUE,n=b.fromCache({depthTest:{enabled:!0},depthMask:!0}),this._pickCommand.renderState=n);var s=this._directionsDirty;if(s){this._directionsDirty=!1,this._va=this._va&&this._va.destroy();var a=this._directions;a&&a.length>=3&&(this._frontFaceColorCommand.vertexArray=G(this,i),this._backFaceColorCommand.vertexArray=this._frontFaceColorCommand.vertexArray,this._pickCommand.vertexArray=this._frontFaceColorCommand.vertexArray)}if(t(this._frontFaceColorCommand.vertexArray)){var h=e.passes,c=!p.equals(this.modelMatrix,this._modelMatrix);c&&p.clone(this.modelMatrix,this._modelMatrix),(s||c)&&w.transform(this._boundingSphere,this.modelMatrix,this._boundingSphereWC),this._frontFaceColorCommand.modelMatrix=this.modelMatrix,this._backFaceColorCommand.modelMatrix=this._frontFaceColorCommand.modelMatrix,this._pickCommand.modelMatrix=this._frontFaceColorCommand.modelMatrix;var u=this._lateralSurfaceMaterial!==this.lateralSurfaceMaterial;if(this._lateralSurfaceMaterial=this.lateralSurfaceMaterial,this._lateralSurfaceMaterial.update(i),h.render){var d=this._frontFaceColorCommand,m=this._backFaceColorCommand;if(u||!t(d.shaderProgram)){var f=new k({sources:[z,this._lateralSurfaceMaterial.shaderSource,R]});d.shaderProgram=E.replaceCache({context:i,shaderProgram:d.shaderProgram,vertexShaderSource:N,fragmentShaderSource:f,attributeLocations:q}),d.uniformMap=S(this._uniforms,this._lateralSurfaceMaterial._uniforms),m.shaderProgram=d.shaderProgram,m.uniformMap=S(this._uniforms,this._lateralSurfaceMaterial._uniforms),m.uniformMap.u_normalDirection=function(){return-1}}r?o.push(this._backFaceColorCommand,this._frontFaceColorCommand):o.push(this._frontFaceColorCommand)}if(h.pick){var _=this._pickCommand;if(t(this._pickId)&&this._id===this.id||(this._id=this.id,this._pickId=this._pickId&&this._pickId.destroy(),this._pickId=i.createPickId({primitive:this._pickPrimitive,id:this.id})),u||!t(_.shaderProgram)){var C=new k({sources:[z,this._lateralSurfaceMaterial.shaderSource,R],pickColorQualifier:"uniform"});_.shaderProgram=E.replaceCache({context:i,shaderProgram:_.shaderProgram,vertexShaderSource:N,fragmentShaderSource:C,attributeLocations:q});var g=this,v={czm_pickColor:function(){return g._pickId.color}};_.uniformMap=S(S(this._uniforms,this._lateralSurfaceMaterial._uniforms),v)}_.pass=r?T.TRANSLUCENT:T.OPAQUE,o.push(_)}}}},L.prototype.isDestroyed=function(){return!1},L.prototype.destroy=function(){return this._frontFaceColorCommand.vertexArray=this._frontFaceColorCommand.vertexArray&&this._frontFaceColorCommand.vertexArray.destroy(),this._frontFaceColorCommand.shaderProgram=this._frontFaceColorCommand.shaderProgram&&this._frontFaceColorCommand.shaderProgram.destroy(),this._pickCommand.shaderProgram=this._pickCommand.shaderProgram&&this._pickCommand.shaderProgram.destroy(),this._pickId=this._pickId&&this._pickId.destroy(),m(this)};const K=i.WHITE,Z=Number.POSITIVE_INFINITY,X=new _,$=new e,ee=new C;function ie(e,i,n,r){var s=i[e];t(s)||(s=new o,i[e]=s),s.clock=n,s.cone=r,s.magnitude=1}function te(e,i,t,o,n){var r,s=e.directions,a=0,l=f.toRadians(2);if(0===i&&t===f.TWO_PI)for(r=0;r<f.TWO_PI;r+=l)ie(a++,s,r,n);else{for(r=i;r<t;r+=l)ie(a++,s,r,n);if(ie(a++,s,t,n),o){for(r=t;r>i;r-=l)ie(a++,s,r,o);ie(a++,s,i,o)}else ie(a++,s,t,0)}s.length=a,e.directions=s}const oe=function(e,i){if(!t(e))throw new l("scene is required.");if(!t(i))throw new l("entityCollection is required.");i.collectionChanged.addEventListener(oe.prototype._onCollectionChanged,this),this._scene=e,this._primitives=e.primitives,this._entityCollection=i,this._hash={},this._entitiesToVisualize=new d,this._onCollectionChanged(i,i.values,[],[])};oe.prototype.update=function(i){if(!t(i))throw new l("time is required.");for(var o=this._entitiesToVisualize.values,n=this._hash,r=this._primitives,s=0,a=o.length;s<a;s++){var h,c,u=o[s],d=u._conicSensor,m=n[u.id],w=u.isShowing&&u.isAvailable(i)&&v.getValueOrDefault(d._show,i,!0);if(w&&(h=v.getValueOrUndefined(u._position,i,$),c=v.getValueOrUndefined(u._orientation,i,ee),w=t(h)&&t(c)),w){var S=t(m)?m.primitive:void 0;t(S)||((S=new L).id=u,r.add(S),m={primitive:S,position:void 0,orientation:void 0,minimumClockAngle:void 0,maximumClockAngle:void 0,innerHalfAngle:void 0,outerHalfAngle:void 0},n[u.id]=m),e.equals(h,m.position)&&C.equals(c,m.orientation)||(p.fromRotationTranslation(_.fromQuaternion(c,X),h,S.modelMatrix),m.position=e.clone(h,m.position),m.orientation=C.clone(c,m.orientation)),S.show=!0;var y=v.getValueOrDefault(d._minimumClockAngle,i,0),A=v.getValueOrDefault(d._maximumClockAngle,i,f.TWO_PI),M=v.getValueOrDefault(d._innerHalfAngle,i,0),x=v.getValueOrDefault(d._outerHalfAngle,i,Math.PI);y===m.minimumClockAngle&&A===m.maximumClockAngle&&M===m.innerHalfAngle&&x===m.outerHalfAngle||(te(S,y,A,M,x),m.innerHalfAngle=M,m.maximumClockAngle=A,m.outerHalfAngle=x,m.minimumClockAngle=y),S.radius=v.getValueOrDefault(d._radius,i,Z),S.lateralSurfaceMaterial=g.getValue(i,d._lateralSurfaceMaterial,S.lateralSurfaceMaterial),S.intersectionColor=v.getValueOrClonedDefault(d._intersectionColor,i,K,S.intersectionColor),S.intersectionWidth=v.getValueOrDefault(d._intersectionWidth,i,1)}else t(m)&&(m.primitive.show=!1)}return!0},oe.prototype.isDestroyed=function(){return!1},oe.prototype.destroy=function(){for(var e=this._entitiesToVisualize.values,i=this._hash,t=this._primitives,o=e.length-1;o>-1;o--)J(e[o],i,t);return m(this)},oe.prototype._onCollectionChanged=function(e,i,o,n){var r,s,a=this._entitiesToVisualize,l=this._hash,h=this._primitives;for(r=i.length-1;r>-1;r--)s=i[r],t(s._conicSensor)&&t(s._position)&&t(s._orientation)&&a.set(s.id,s);for(r=n.length-1;r>-1;r--)s=n[r],t(s._conicSensor)&&t(s._position)&&t(s._orientation)?a.set(s.id,s):(J(s,l,h),a.remove(s.id));for(r=o.length-1;r>-1;r--)J(s=o[r],l,h),a.remove(s.id)};const ne=function(e){this._directions=void 0,this._directionsSubscription=void 0,this._lateralSurfaceMaterial=void 0,this._lateralSurfaceMaterialSubscription=void 0,this._intersectionColor=void 0,this._intersectionColorSubscription=void 0,this._intersectionWidth=void 0,this._intersectionWidthSubscription=void 0,this._showIntersection=void 0,this._showIntersectionSubscription=void 0,this._radius=void 0,this._radiusSubscription=void 0,this._show=void 0,this._showSubscription=void 0,this._definitionChanged=new h,this.merge(a(e,a.EMPTY_OBJECT))};Object.defineProperties(ne.prototype,{definitionChanged:{get:function(){return this._definitionChanged}},directions:u("directions"),lateralSurfaceMaterial:c("lateralSurfaceMaterial"),intersectionColor:u("intersectionColor"),intersectionWidth:u("intersectionWidth"),showIntersection:u("showIntersection"),radius:u("radius"),show:u("show")}),ne.prototype.clone=function(e){return t(e)||(e=new ne),e.directions=this.directions,e.radius=this.radius,e.show=this.show,e.showIntersection=this.showIntersection,e.intersectionColor=this.intersectionColor,e.intersectionWidth=this.intersectionWidth,e.lateralSurfaceMaterial=this.lateralSurfaceMaterial,e},ne.prototype.merge=function(e){if(!t(e))throw new l("source is required.");this.directions=a(this.directions,e.directions),this.radius=a(this.radius,e.radius),this.show=a(this.show,e.show),this.showIntersection=a(this.showIntersection,e.showIntersection),this.intersectionColor=a(this.intersectionColor,e.intersectionColor),this.intersectionWidth=a(this.intersectionWidth,e.intersectionWidth),this.lateralSurfaceMaterial=a(this.lateralSurfaceMaterial,e.lateralSurfaceMaterial)};const re=i.WHITE,se=Number.POSITIVE_INFINITY,ae=new _,le=new e,he=new C,ce=function(e,i){if(!t(e))throw new l("scene is required.");if(!t(i))throw new l("entityCollection is required.");i.collectionChanged.addEventListener(ce.prototype._onCollectionChanged,this),this._scene=e,this._primitives=e.primitives,this._entityCollection=i,this._hash={},this._entitiesToVisualize=new d,this._onCollectionChanged(i,i.values,[],[])};ce.prototype.update=function(i){if(!t(i))throw new l("time is required.");for(var o=this._entitiesToVisualize.values,n=this._hash,r=this._primitives,s=0,a=o.length;s<a;s++){var h,c,u,d=o[s],m=d._customPatternSensor,f=n[d.id],w=d.isShowing&&d.isAvailable(i)&&v.getValueOrDefault(m._show,i,!0);if(w&&(h=v.getValueOrUndefined(d._position,i,le),c=v.getValueOrUndefined(d._orientation,i,he),u=v.getValueOrUndefined(m._directions,i),w=t(h)&&t(c)&&t(u)),w){var S=t(f)?f.primitive:void 0;t(S)||((S=new L).id=d,r.add(S),f={primitive:S,position:void 0,orientation:void 0},n[d.id]=f),e.equals(h,f.position)&&C.equals(c,f.orientation)||(p.fromRotationTranslation(_.fromQuaternion(c,ae),h,S.modelMatrix),f.position=e.clone(h,f.position),f.orientation=C.clone(c,f.orientation)),S.show=!0,S.directions=u,S.radius=v.getValueOrDefault(m._radius,i,se),S.lateralSurfaceMaterial=g.getValue(i,m._lateralSurfaceMaterial,S.lateralSurfaceMaterial),S.intersectionColor=v.getValueOrClonedDefault(m._intersectionColor,i,re,S.intersectionColor),S.intersectionWidth=v.getValueOrDefault(m._intersectionWidth,i,1)}else t(f)&&(f.primitive.show=!1)}return!0},ce.prototype.isDestroyed=function(){return!1},ce.prototype.destroy=function(){for(var e=this._entitiesToVisualize.values,i=this._hash,t=this._primitives,o=e.length-1;o>-1;o--)J(e[o],i,t);return m(this)},ce.prototype._onCollectionChanged=function(e,i,o,n){var r,s,a=this._entitiesToVisualize,l=this._hash,h=this._primitives;for(r=i.length-1;r>-1;r--)s=i[r],t(s._customPatternSensor)&&t(s._position)&&t(s._orientation)&&a.set(s.id,s);for(r=n.length-1;r>-1;r--)s=n[r],t(s._customPatternSensor)&&t(s._position)&&t(s._orientation)?a.set(s.id,s):(J(s,l,h),a.remove(s.id));for(r=o.length-1;r>-1;r--)J(s=o[r],l,h),a.remove(s.id)};const ue=function(){this._xHalfAngle=void 0,this._xHalfAngleSubscription=void 0,this._yHalfAngle=void 0,this._yHalfAngleSubscription=void 0,this._lateralSurfaceMaterial=void 0,this._lateralSurfaceMaterialSubscription=void 0,this._intersectionColor=void 0,this._intersectionColorSubscription=void 0,this._intersectionWidth=void 0,this._intersectionWidthSubscription=void 0,this._showIntersection=void 0,this._showIntersectionSubscription=void 0,this._radius=void 0,this._radiusSubscription=void 0,this._show=void 0,this._showSubscription=void 0,this._definitionChanged=new h};function de(e,i,n,r){var s=i[e];t(s)||(s=new o,i[e]=s),s.clock=n,s.cone=r,s.magnitude=1}function me(e){var i=e._customSensor.directions,t=Math.tan(Math.min(e._xHalfAngle,f.toRadians(89))),o=Math.tan(Math.min(e._yHalfAngle,f.toRadians(89))),n=Math.atan(t/o),r=Math.atan(Math.sqrt(t*t+o*o));de(0,i,n,r),de(1,i,f.toRadians(180)-n,r),de(2,i,f.toRadians(180)+n,r),de(3,i,-n,r),i.length=4,e._customSensor.directions=i}Object.defineProperties(ue.prototype,{definitionChanged:{get:function(){return this._definitionChanged}},xHalfAngle:u("xHalfAngle"),yHalfAngle:u("yHalfAngle"),lateralSurfaceMaterial:u("lateralSurfaceMaterial"),intersectionColor:u("intersectionColor"),intersectionWidth:u("intersectionWidth"),showIntersection:u("showIntersection"),radius:u("radius"),show:u("show")}),ue.prototype.clone=function(e){return t(e)||(e=new ue),e.xHalfAngle=this.xHalfAngle,e.yHalfAngle=this.yHalfAngle,e.radius=this.radius,e.show=this.show,e.showIntersection=this.showIntersection,e.intersectionColor=this.intersectionColor,e.intersectionWidth=this.intersectionWidth,e.lateralSurfaceMaterial=this.lateralSurfaceMaterial,e},ue.prototype.merge=function(e){if(!t(e))throw new l("source is required.");this.xHalfAngle=a(this.xHalfAngle,e.xHalfAngle),this.yHalfAngle=a(this.yHalfAngle,e.yHalfAngle),this.radius=a(this.radius,e.radius),this.show=a(this.show,e.show),this.showIntersection=a(this.showIntersection,e.showIntersection),this.intersectionColor=a(this.intersectionColor,e.intersectionColor),this.intersectionWidth=a(this.intersectionWidth,e.intersectionWidth),this.lateralSurfaceMaterial=a(this.lateralSurfaceMaterial,e.lateralSurfaceMaterial)};const fe=function(e){e=a(e,a.EMPTY_OBJECT);var i=F(e);i._pickPrimitive=a(e._pickPrimitive,this),i.directions=void 0,this._customSensor=new L(i),this._xHalfAngle=a(e.xHalfAngle,f.PI_OVER_TWO),this._yHalfAngle=a(e.yHalfAngle,f.PI_OVER_TWO),me(this)};Object.defineProperties(fe.prototype,{xHalfAngle:{get:function(){return this._xHalfAngle},set:function(e){if(e>f.PI_OVER_TWO)throw new l("xHalfAngle must be less than or equal to 90 degrees.");this._xHalfAngle!==e&&(this._xHalfAngle=e,me(this))}},yHalfAngle:{get:function(){return this._yHalfAngle},set:function(e){if(e>f.PI_OVER_TWO)throw new l("yHalfAngle must be less than or equal to 90 degrees.");this._yHalfAngle!==e&&(this._yHalfAngle=e,me(this))}},show:{get:function(){return this._customSensor.show},set:function(e){this._customSensor.show=e}},showIntersection:{get:function(){return this._customSensor.showIntersection},set:function(e){this._customSensor.showIntersection=e}},showThroughEllipsoid:{get:function(){return this._customSensor.showThroughEllipsoid},set:function(e){this._customSensor.showThroughEllipsoid=e}},modelMatrix:{get:function(){return this._customSensor.modelMatrix},set:function(e){this._customSensor.modelMatrix=e}},radius:{get:function(){return this._customSensor.radius},set:function(e){this._customSensor.radius=e}},lateralSurfaceMaterial:{get:function(){return this._customSensor.lateralSurfaceMaterial},set:function(e){this._customSensor.lateralSurfaceMaterial=e}},intersectionColor:{get:function(){return this._customSensor.intersectionColor},set:function(e){this._customSensor.intersectionColor=e}},intersectionWidth:{get:function(){return this._customSensor.intersectionWidth},set:function(e){this._customSensor.intersectionWidth=e}},id:{get:function(){return this._customSensor.id},set:function(e){this._customSensor.id=e}}}),fe.prototype.update=function(e){this._customSensor.update(e)},fe.prototype.isDestroyed=function(){return!1},fe.prototype.destroy=function(){return this._customSensor=this._customSensor&&this._customSensor.destroy(),m(this)};const _e=i.WHITE,pe=Number.POSITIVE_INFINITY,Ce=new _,ge=new e,ve=new C,we=function(e,i){if(!t(e))throw new l("scene is required.");if(!t(i))throw new l("entityCollection is required.");i.collectionChanged.addEventListener(we.prototype._onCollectionChanged,this),this._scene=e,this._primitives=e.primitives,this._entityCollection=i,this._hash={},this._entitiesToVisualize=new d,this._onCollectionChanged(i,i.values,[],[])};we.prototype.update=function(i){if(!t(i))throw new l("time is required.");for(var o=this._entitiesToVisualize.values,n=this._hash,r=this._primitives,s=0,a=o.length;s<a;s++){var h,c,u=o[s],d=u._rectangularSensor,m=n[u.id],w=u.isShowing&&u.isAvailable(i)&&v.getValueOrDefault(d._show,i,!0);if(w&&(h=v.getValueOrUndefined(u._position,i,ge),c=v.getValueOrUndefined(u._orientation,i,ve),w=t(h)&&t(c)),w){var S=t(m)?m.primitive:void 0;t(S)||((S=new fe).id=u,r.add(S),m={primitive:S,position:void 0,orientation:void 0},n[u.id]=m),e.equals(h,m.position)&&C.equals(c,m.orientation)||(p.fromRotationTranslation(_.fromQuaternion(c,Ce),h,S.modelMatrix),m.position=e.clone(h,m.position),m.orientation=C.clone(c,m.orientation)),S.show=!0,S.xHalfAngle=v.getValueOrDefault(d._xHalfAngle,i,f.PI_OVER_TWO),S.yHalfAngle=v.getValueOrDefault(d._yHalfAngle,i,f.PI_OVER_TWO),S.radius=v.getValueOrDefault(d._radius,i,pe),S.lateralSurfaceMaterial=g.getValue(i,d._lateralSurfaceMaterial,S.lateralSurfaceMaterial),S.intersectionColor=v.getValueOrClonedDefault(d._intersectionColor,i,_e,S.intersectionColor),S.intersectionWidth=v.getValueOrDefault(d._intersectionWidth,i,1)}else t(m)&&(m.primitive.show=!1)}return!0},we.prototype.isDestroyed=function(){return!1},we.prototype.destroy=function(){for(var e=this._entitiesToVisualize.values,i=this._hash,t=this._primitives,o=e.length-1;o>-1;o--)J(e[o],i,t);return m(this)},we.prototype._onCollectionChanged=function(e,i,o,n){var r,s,a=this._entitiesToVisualize,l=this._hash,h=this._primitives;for(r=i.length-1;r>-1;r--)s=i[r],t(s._rectangularSensor)&&t(s._position)&&t(s._orientation)&&a.set(s.id,s);for(r=n.length-1;r>-1;r--)s=n[r],t(s._rectangularSensor)&&t(s._position)&&t(s._orientation)?a.set(s.id,s):(J(s,l,h),a.remove(s.id));for(r=o.length-1;r>-1;r--)J(s=o[r],l,h),a.remove(s.id)};var Se=r.processPacketData,ye=r.processMaterialPacketData;function Ae(i,n,r,s,a){var l,h,c=[],u=n.unitSpherical,d=n.spherical,m=n.unitCartesian,f=n.cartesian;if(t(u)){for(l=0,h=u.length;l<h;l+=2)c.push(new o(u[l],u[l+1]));n.array=c}else if(t(d)){for(l=0,h=d.length;l<h;l+=3)c.push(new o(d[l],d[l+1],d[l+2]));n.array=c}else if(t(m)){for(l=0,h=m.length;l<h;l+=3){var _=o.fromCartesian3(new e(m[l],m[l+1],m[l+2]));o.normalize(_,_),c.push(_)}n.array=c}else if(t(f)){for(l=0,h=f.length;l<h;l+=3)c.push(o.fromCartesian3(new e(f[l],f[l+1],f[l+2])));n.array=c}Se(Array,i,"directions",n,r,s,a)}function Me(e,t,o,n,r){Se(Boolean,e,"show",t.show,o,n,r),Se(Number,e,"radius",t.radius,o,n,r),Se(Boolean,e,"showIntersection",t.showIntersection,o,n,r),Se(i,e,"intersectionColor",t.intersectionColor,o,n,r),Se(Number,e,"intersectionWidth",t.intersectionWidth,o,n,r),ye(e,"lateralSurfaceMaterial",t.lateralSurfaceMaterial,o,n,r)}var xe={iso8601:void 0};function Ie(e,i,o,r){var s=i.agi_conicSensor;if(t(s)){var a,l=s.interval;t(l)&&(xe.iso8601=l,a=n.fromIso8601(xe));var h=e.conicSensor;t(h)||(e.addProperty("conicSensor"),h=new D,e.conicSensor=h),Me(h,s,a,r,o),Se(Number,h,"innerHalfAngle",s.innerHalfAngle,a,r,o),Se(Number,h,"outerHalfAngle",s.outerHalfAngle,a,r,o),Se(Number,h,"minimumClockAngle",s.minimumClockAngle,a,r,o),Se(Number,h,"maximumClockAngle",s.maximumClockAngle,a,r,o)}}function Te(e,i,o,r){var s=i.agi_customPatternSensor;if(t(s)){var a,l=s.interval;t(l)&&(xe.iso8601=l,a=n.fromIso8601(xe));var h=e.customPatternSensor;t(h)||(e.addProperty("customPatternSensor"),h=new ne,e.customPatternSensor=h),Me(h,s,a,r,o);var c=s.directions;if(t(c))if(Array.isArray(c))for(var u=c.length,d=0;d<u;d++)Ae(h,c[d],a,r,o);else Ae(h,c,a,r,o)}}function be(e,i,o,r){var s=i.agi_rectangularSensor;if(t(s)){var a,l=s.interval;t(l)&&(xe.iso8601=l,a=n.fromIso8601(xe));var h=e.rectangularSensor;t(h)||(e.addProperty("rectangularSensor"),h=new ue,e.rectangularSensor=h),Me(h,s,a,r,o),Se(Number,h,"xHalfAngle",s.xHalfAngle,a,r,o),Se(Number,h,"yHalfAngle",s.yHalfAngle,a,r,o)}}var Ee=!1;return function(){if(!Ee){r.updaters.push(Ie,Te,be);var e=s.defaultVisualizersCallback;s.defaultVisualizersCallback=function(i,t,o){var n=o.entities;return e(i,t,o).concat([new oe(i,n),new ce(i,n),new we(i,n)])},Ee=!0}}(),{ConicSensorGraphics:D,ConicSensorVisualizer:oe,CustomPatternSensorGraphics:ne,CustomPatternSensorVisualizer:ce,CustomSensorVolume:L,RectangularPyramidSensorVolume:fe,RectangularSensorGraphics:ue,RectangularSensorVisualizer:we}}));
